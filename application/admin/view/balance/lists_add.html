
<div class="wrapper wrapper-content animated fadeInRight" style="height: 100%;">
	<div class="row">
		<div class="col-sm-12">
			<div class="ibox float-e-margins">
				<div class="ibox-title">
					<h5>添加资产 </h5>
				</div>
				<div class="ibox-content">
					<form class="form-builder row" id="form" method="post" autocomplete="off">
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" for="name">编号</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="code" value="{$data['code']}" placeholder="请输入编码">
							</div>
						</div>
					<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >名称</label>
							<div class="col-sm-12">

								<input class="form-control" type="text" name="title" value="{$data['title']}" placeholder="请输入名称">

							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" for="customer_name">类别</label>
							<div class="col-sm-12">
								<select onchange="cateChange(this.value)" class="s-select2 form-control select2-hidden-accessible" name="cate">
									<option value="0">一级分类</option>
								</select>
							</div>
						</div>

						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >规格</label>
							<div class="col-sm-12">

								<input class="form-control" type="text" name="spec" value="{$data['spec']}" placeholder="请输入规格">

							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >测量范围</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="random" value="{$data['random']}" placeholder="请输入测量范围">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >精确度</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="exact" value="{$data['exact']}" placeholder="请输入精确度">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >制造商</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="maker" value="{$data['maker']}" placeholder="请输入制造商">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >出厂编号</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="number" value="{$data['number']}" placeholder="请输入出厂编号">
							</div>
						</div>
						
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >发票金额(元)</label>
							<div class="col-sm-12">
								<input class="form-control" type="number" name="invoice_moeny" value="{$data['invoice_moeny']}" placeholder="请输入发票金额">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >发票日期</label>
							<div class="col-sm-12">
								<input class="form-control" id="invoice_date" type="text" name="invoice_date" placeholder="YYYY-MM-DD" >
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >采购人</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="purchaser" value="{$data['purchaser']}" placeholder="请输入采购人">
							</div>
						</div>
						<div class="form-group  col-md-4 col-xs-12">
                            <label class="col-xs-12" >质保到期日</label>
                            <div class="col-sm-12">
                                <input id="end_time" name="end_time" class="form-control" placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                    	<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >折旧年限(年)</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="age_limit" value="{$data['age_limit']}" placeholder="请输入折旧年限">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >残值率(%)</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="remaining" value="{$data['remaining']}" placeholder="请输入残值率">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >检定机构</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="verification" value="{$data['verification']}" placeholder="请输入检定机构">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >检定周期(月)</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="cycle" value="{$data['cycle']}" placeholder="请输入检定周期">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >检定编号</label>
							<div class="col-sm-12">
								<input class="form-control" type="text" name="verification_number" value="{$data['verification_number']}" placeholder="请输入检定编号">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >检定日</label>
							<div class="col-sm-12">
                                <input id="verification_date" name="verification_date" class="form-control" placeholder="YYYY-MM-DD" >
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >检定结果</label>
							<div class="col-sm-12">
                                <input name="result" class="form-control" value="{$data['result']}" placeholder="请输入检定结果">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" >检定到期日</label>
							<div class="col-sm-12">
                                <input id="expir" name="expir" class="form-control" placeholder="YYYY-MM-DD">
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" for="customer_name">领用人</label>
							<div class="col-sm-12">
								<select class="js-select2 form-control select2-hidden-accessible" name="recipient">
									<option value="8">1</option>
									<option value="8">21</option>
									<option value="8">21</option>
									<option value="8">12</option>
								</select>
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" for="customer_name">责任部门</label>
							<div class="col-sm-12">
								<select class="js-select2 form-control select2-hidden-accessible" name="duty">
									<option value="8">1</option>
									<option value="8">21</option>
									<option value="8">21</option>
									<option value="8">12</option>
								</select>
							</div>
						</div>
						<div class="form-group col-md-4 col-xs-12 ">
							<label class="col-xs-12" for="customer_name">状态</label>
							<div class="col-sm-12">
								<select class="js-select2 form-control select2-hidden-accessible" name="status">
									<option value="1">可用</option>
									<option value="2">领用</option>
									<option value="3">维修</option>
									<option value="4">报废</option>
								</select>
							</div>
						</div>
						<div class="form-group col-md-12 col-xs-12 ">
						    <label class="col-xs-12" for="file">附件</label>
						    <div class="col-sm-12 js-upload-files">
						    	<ul class="list-group uploader-list" id="file_list_file">
                    				{notempty name="$files"}
                    				{volist name="files" id="f"}
                    				<li class="list-group-item file-item">
                    					<span class="pull-right file-state">
                    						<span class="text-success">已上传</span>
                    					</span>
                    					<i class="fa fa-file"></i> 
                    					{$f['name']}
                    					 [<a href="{$f['path']}" class="download-file" download="{$f['name']}">下载</a>]
                    					 [<a class="remove-file" onclick="deleteFile({$f['id']}, this)">删除</a>]
                    				</li>
                    				{php}
                    					$files_ids = [];
                    					array_push($files_ids, $f['id']);
                    				{/php}
                    				{/volist}
                    				{/notempty}
						    	</ul>
						    	<div onclick="document.querySelector('#addFiles').click()" class="webuploader-pick">上传多个文件</div>
			            </div>
						</div>
						<div class="form-group col-md-12 col-xs-12 ">
						    <label class="col-xs-12" for="note">备注</label>
						    <div class="col-xs-12">
						        <textarea class="form-control" id="note" rows="7" name="note" placeholder="请输入备注">{$data['note']}</textarea>
				            </div>
						</div>
				    
					<div class="col-xs-12">
                          <button class="btn btn-minw btn-primary ajax-post" onclick="add()" target-form="form-builder" type="button">
                        		提交                                       
                          </button>
                           <button class="btn btn-default" type="button" onclick="javascript:history.back(-1);return false;">
                            	返回 
                           </button>
                         </div>
					</form>
					<form id="file">
						<input class="none" type="file" id="addFiles" name="file[]" multiple="multiple" onchange="addFile()"  value="" />
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
var index = layer.open({
  type: 1, 
  title:'图标',
   area: ['850px', 'auto'],
  content: `{include file="public/icon"}` 
});
function iconClick (i){
	console.log(i)
	layer.close(index)
}
(function(){
	
	var strs = '';
	tree({:json_encode($tree)});
	
	function tree (data){
		for (var i in data) {
			var level = '';
			if (data[i]['level'] > 1) {
			    var arr = [];
			    arr.length = data[i]['level'];
				level += arr.join('&nbsp;&nbsp;&nbsp;&nbsp;');
				level += '┝ ';
			}
			strs = strs + '<option  value="' + data[i]['id'] + '">' + level + data[i]['title'] + '</option>';
			if(data[i].children.length != 0){
				tree(data[i].children);
			}
		}
	}
	var sel = $("select[name='cate']");
	sel.append(strs);
		{notempty name="$data['id']"}
			sel.find('option[value="{$data['cate']}"]').prop('selected', 'selected');
			$("select[name='status']").find('option[value="{$data['status']}"]').prop('selected', 'selected');
		{/notempty}
})()
</script>

<script type="text/javascript">
	       laydate.render({
            elem: '#end_time', 
            event: 'focus',
        	value: '{$data['end_time']}',
	       });
          laydate.render({
            elem: '#verification_date', 
            event: 'focus', 
       		value: '{$data['verification_date']}'
          });
           laydate.render({
            elem: '#expir', 
            event: 'focus', 
       		value: '{$data['expir']}'
       });
        laydate.render({
            elem: '#invoice_date', 
            event: 'focus', 
       		value: '{$data['invoice_date']}'
        });
</script>

<script type="text/javascript">
	//附件id
	{empty name="files_ids"}
		var fileids = [];
		{else /}
		var fileids = {:json_encode($files_ids)};
	{/empty}
	
	
	function cateChange(val){
		$.ajax({
			type:"post",
			url:"{:url('CateGetOne')}",
			async:true,
			data: {id: val},
			success: function(res){
				var data = res.data;
				$('input[name="age_limit"]').val(data.age_limit);
				$('input[name="remaining"]').val(data.remaining);
			}
		});
	}
	function add(){
		var seeting = {
			id: 'form',
			url: '{:url("lists_add")}',
			validate: [
				["code",  '编号不能为空'],
			    ["title",  '标题不能为空'],
			    ["cate",  '类别不能为空'],
			    ["spec",  '规格不能为空'],
			    ["random",  '测量范围不能为空'],
			    ["exact",  '精确度不能为空'],
			    ["maker",  '制造商不能为空'],
			    ["number",  '出厂编号不能为空'],
			    ["verification_number",  '检定编号不能为空'],
		    	["verification_date",  '检定日期不能为空'],
			    ["purchaser",  '采购人不能为空'],
			    ["end_time",  '质保到期日不能为空'],
			    ["age_limit",  '折旧年限不能为空'],
			    ["remaining",  '残值率不能为空'],
			    ["verification",  '检定机构不能为空'],
			    ["cycle",  '检定周期不能为空'],
			    ["result",  '检定结果不能为空'],
			    ["expir",  '检定日期不能为空'],
			    ["recipient",  '领用人不能为空'],
			    ["duty",  '责任部门不能为空'],
			    ["status",  '状态不能为空'],
			],
			append: []
		}
		//提交
		if (fileids.length > 0) {
			seeting.append.push(['file', fileids.join(',')]);
		}
		{notempty name="$data['id']"}
			seeting.append.push(['id', {$data['id']}]);
		{/notempty}
		util.ajax(seeting).then(function(res){
			alert(res.msg);
			if(res.code == 0){
				$('input[name="'+res.data+'"]').focus();
			}
			if (res.code == 1) {
				setTimeout(function(){
					location.href = '{:url("index")}'
				}, 1500)
			}
		}).catch(e => {
			console.log(e);
			alert('系统错误, 请联系管理员');
		})
	}

	function addFile(){
		
		var seeting = {
			id: 'file',
			validate: [
				["file",  '附件不能为空'],
			],
			append: [['to_dir', 'balance']],
			url: "{:url('AdminFiles/UpLoadFiles')}",
		}
		//提交
		util.ajax(seeting).then(function(res){
			
			if (res.code == 1) {
				var success = res.data.success;
				var str = '';
				for (var i = 0;  i < success.length; i ++) {
					fileids.push(Number(success[i]['id']));
					str += `<li class="list-group-item file-item">
                    					<span class="pull-right file-state">
                    						<span class="text-success">上传成功</span>
                    					</span>
                    					<i class="fa fa-file"></i> 
                    					${success[i]['name']}
                    					 [<a href="${success[i]['path']}" class="download-file" download="${success[i]['name']}">下载</a>]
                    					 [<a class="remove-file" onclick="deleteFile(${success[i]['id']}, this)">删除</a>]
                    				</li>`;
				}
				var fail = res.data.fail;
				
				for (var i = 0;  i < fail.length; i ++) {
					str += `<li class="list-group-item file-item">
                    					<span class="pull-right file-state">
                    						<span class="text-success">上传失败(${fail[i]['err']})</span>
                    					</span>
                    					<i class="fa fa-file"></i> 
                    					${fail[i]['name']}
                    				</li>`;
				}
				$("#file_list_file").append(str);
			} else {
				alert('上传失败');
			}
		}).catch(e => {
			console.log(e);
			alert('上传失败, 请联系管理员');
		})
	

	}
	
	function deleteFile(id, o){
		var index = fileids.indexOf(Number(id));
		if (index !== -1) {
			fileids.splice(index, 1);
			$(o).parents('li').remove();
		}
	}
</script>